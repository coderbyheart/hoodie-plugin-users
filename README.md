Hoodie Users Plugin
===================

The worker of the Users Plugin listens to the [changes feed] of the `_users`
database. If a new doc of type: "user" pops up the worker confirms the user (if
auto confirmation is enabled).  To confirm a user, the worker creates a
database "user/uuid567", `uuid567` being the autogenerated and globally unique
user hash. It then sets the [database security] so that only user
`joe@example.com` can access it. Once finished, the `_users` doc will be
flagged as confirmed by setting `roles` to `["confirmed", "uuid567"]`. If an
error occured, the `roles` property will be set to `["error"]` and an `$error`
property will be added with an explanation.  


Username changes
----------------

Changing a username is rather tricky in CouchDB land, as the username is part
of the `_users` doc._id.  So instead, an entire new doc has to be created and
the the old one needs to be removed.

When the user runs `hoodie.account.changeUsername('secret',
'newjoe@example.com')`, the user's `_users` doc will be updated with a new
property: `"$newUsername": "newjoe@example.com"`. The users worker will pick
that up, create a new doc with `"_id":
"org.couchdb.user:user/newjoe@example.com"`, copy over all properties and then
remove the old document. `hoodie.account.changeUsername` checks if the old
`_users` doc has been removed.  Once that happened, it will sign out silently,
sign back in using the new username and then resolve its promise.  


Password resets
---------------

The only database that a signed out user can write to securely (without other
users being able to read it) is the `_users` database. So when a user runs
`hoodie.account.resetPassword( "joe@example.com" )`, we create a special object
with `"_id": "org.couchdb.user:$passwordReset/joe@example.com/uuid123"`.
`uuid123` is a globally unique id that gets generated for the password reset
and stored locally in the user's browser. The `$passwordReset` doc is
technically a CouchDB user, so we set the password to `uuid123` as well.

The worker picks up new `$passwordReset`, generates a new password for
`joe@example.com`, updates Joe's `_users` doc and deletes `$passwordReset`
again. If there is an error, it updates the `$passwordReset` doc with a
descriptive `$error` property instead.

In the browser, `hoodie.account.resetPassword` listens to changes on the
`$passwordReset` doc. If it gets removed, it resolves its promise. If the
`$error` property gets added, it rejects with its message.


Anonymous users
---------------

Hoodie can be used entirely without accounts. That usually means, that data
gets only stored in the user's browser. There are cases though when data needs
to be synchronized to CouchDB, for example when an anonymous user wants to send
an email, share data or do any different kind background tasks. You might also
decide as an app developer that you want to store data of anonymous users to
prevent data loss.

To create an account for an anonymous user and to kick off data
synchronization, you can use `hoodie.account.anonymousSignUp()`. This will
create a doc in `_users` that looks similar to what
`hoodie.account.signUp(username, password)` generates: 

```json
{
   "_id": "org.couchdb.user:anonymous_user/uuid567",
   "_rev": "4f9b7ea8424eb477b8cbb6cba49e0dd5",
   "name": "user/uuid567",
   "roles": [],
   "type": "user",
   "ownerHash": "uuid567",
   "database": "user/uuid567",
   "password_scheme": "pbkdf2",
   "derived_key": "4b1d247f488fd4f335a4e0d16f2c5386a5ac98b1",
   "salt": "564aa550233a06f3bbed1cf014ee21e1"
}
```

The only differences are:

1. `username` gets set to the users autogenerated hash, which is a globally
   unique uuid.
2. `password` gets generated and stored locally in the users browser.


To run tests / linting
----------------------

You'll need to have phantomjs and grunt installed:

```
npm install -g phantomjs grunt-cli
```

Install dev dependencies:

```
npm install
```

Then run the 'test' task

```
grunt test
```

You can also run `test:unit` or `test:browser` individually.

If your plugin depends on other plugins being present (usually it will at
least depend on the hoodie users plugin), then make sure they're included
in your devDependencies in package.json and listed in the hoodie.plugins
property. This way, they'll also get started when the browser tests are
run.

NOTE: When running the browser tests, the grunt tasks will remove the local
Hoodie 'data' directory completely so you get a clean database to test
against. Be careful you don't use this path for any data you may want to
keep!
